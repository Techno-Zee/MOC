#!/bin/bash
set -euo pipefail

# ================= CONFIG =================
ODOO_DIR="/opt/odoo18"
ODOO_BIN="/opt/odoo18/odoo-bin"
ODOO_CONF="/opt/odoo18/odoo.conf"
N8N="/home/techno/Documents/n8n"

ODOO_SERVICE="odoo18"
PG_SERVICE="postgresql"

COMPOSE="docker compose"
TERMINAL="gnome-terminal"
# ==========================================

clear

while true; do
    echo "=============================="
    echo " ██████╗  ██████╗███████╗"
    echo "██╔═══██╗██╔════╝██╔════╝"
    echo "██║   ██║██║     ███████╗"
    echo "██║   ██║██║     ╚════██║"
    echo "╚██████╔╝╚██████╗███████║"
    echo "╚═════╝  ╚═════╝╚══════╝"
    echo "=============================="
    echo "1) Start Odoo & PostgreSQL"
    echo "2) Stop Odoo & PostgreSQL"
    echo "3) Restart Odoo & PostgreSQL"
    echo "4) Scaffolding Modul Odoo"
    echo "5) Baca Log (Realtime)"
    echo "6) Clone Repo GitHub (Public)"
    echo "7) Shutdown Laptop"
    echo "8) Config n8n"
    echo "9) Edit Config Odoo"
    echo "0) Exit"
    echo "=============================="
    read -rp "Pilih menu: " choice

    case "$choice" in
        1)
            sudo systemctl start "$PG_SERVICE"
            sudo systemctl start "$ODOO_SERVICE"
            echo "[OK] Services started"
            ;;

        2)
            sudo systemctl stop "$ODOO_SERVICE"
            sudo systemctl stop "$PG_SERVICE"
            echo "[OK] Services stopped"
            ;;

        3)
            echo "Restart apa?"
            echo "1) Odoo saja"
            echo "2) PostgreSQL saja"
            echo "3) Odoo & PostgreSQL"
            read -rp "Pilih: " rchoice

            case "$rchoice" in
                1) sudo systemctl restart "$ODOO_SERVICE" ;;
                2) sudo systemctl restart "$PG_SERVICE" ;;
                3)
                    sudo systemctl restart "$PG_SERVICE"
                    sudo systemctl restart "$ODOO_SERVICE"
                    ;;
                *) echo "Pilihan tidak valid" ;;
            esac
            echo "[OK] Restart selesai"
            ;;

        4)
            read -rp "Nama modul: " module
            read -rp "Path addons: " addon_path

            if [[ -z "$module" || -z "$addon_path" ]]; then
                echo "[ERROR] Nama modul / path kosong"
                continue
            fi

            if [[ ! -x "$ODOO_BIN" ]]; then
                echo "[ERROR] odoo-bin tidak ditemukan"
                continue
            fi

            source "$ODOO_DIR"/venv/bin/activate
            sudo "$ODOO_BIN" scaffold "$module" "$addon_path"
            echo "[OK] Modul '$module' dibuat di $addon_path"
            ;;

        5)
            echo "1) Log Odoo"
            echo "2) Log PostgreSQL"
            read -rp "Pilih log: " log_choice

            if command -v "$TERMINAL" >/dev/null; then
                case "$log_choice" in
                    1) $TERMINAL -- bash -c "journalctl -u $ODOO_SERVICE -f; exec bash" ;;
                    2) $TERMINAL -- bash -c "journalctl -u $PG_SERVICE -f; exec bash" ;;
                    *) echo "Pilihan tidak valid" ;;
                esac
            else
                journalctl -u "$ODOO_SERVICE" -f
            fi
            ;;

        6)
            read -rp "URL GitHub (public): " repo
            read -rp "Clone ke path: " clone_path

            if [[ -z "$repo" || -z "$clone_path" ]]; then
                echo "[ERROR] URL atau path kosong"
                continue
            fi

            mkdir -p "$clone_path"
            git clone "$repo" "$clone_path"
            ;;

        7)
            read -rp "Shutdown dalam berapa menit? " minutes
            sudo shutdown -h +"$minutes"
            echo "[OK] Shutdown dijadwalkan $minutes menit lagi"
            ;;

        8)
            if [[ ! -d "$N8N" ]]; then
                echo "[ERROR] Direktori n8n tidak ditemukan"
                continue
            fi

            cd "$N8N"
            echo "1) Start n8n"
            echo "2) Stop n8n"
            echo "3) Restart n8n"
            read -rp "Pilih opsi: " opsi_n8n

            case "$opsi_n8n" in
                1) $COMPOSE start ;;
                2) $COMPOSE stop ;;
                3) $COMPOSE restart ;;
                *) echo "Pilihan tidak valid" ;;
            esac
            ;;

        9)
            if command -v "$TERMINAL" >/dev/null; then
                $TERMINAL -- bash -c "sudo nano $ODOO_CONF; exec bash"
            else
                sudo nano "$ODOO_CONF"
            fi
            ;;

        0)
            echo "Keluar..."
            exit 0
            ;;

        *)
            echo "Menu tidak valid"
            ;;
    esac

    echo
    read -rp "Tekan ENTER untuk lanjut..."
    clear
done
